# Этап 2: Развертывание

## Задачи этапа

### 1. Развертывание PostgreSQL в Docker
Необходимо развернуть СУБД PostgreSQL на сервере или локальной машине внутри Docker контейнера.

**Требования:**
- Написать docker compose файл для развертывания
- Если производится монтирование папки с БД в хостовую систему - добавить ее в .gitignore

### 2. Создание идемпотентных миграций
Необходимо написать SQL скрипты с идемпотентными миграциями для создания отношений, составленных на предыдущем этапе.

**Требования к миграциям:**
- Таблицы должны полностью соответствовать структуре, отображенной на схеме
- Учет всех полей данных, ограничений и связей с другими таблицами
- Миграции должны выполняться автоматически при создании нового контейнера
- Миграции должны выполняться до версии, указанной в переменной окружения `MIGRATION_VERSION` (если переменная не указана - до последней версии)

**Архитектура БД:**
- В кластере СУБД должен быть создан пользователь с правами на создание БД
- От имени этого пользователя должна создаваться БД и выполняться миграции

**Инструменты и подходы:**
- Можно использовать инструменты миграций Flyway/Liquibase
- Либо реализовать sidecar-сервис для выполнения миграций (так как backend отсутствует)

**Количество и версионирование:**
- Миграций должно быть не менее 3
- Таблицы должны быть разделены на несколько миграций
- Каждые новые правки выполняются новой версией миграции

### 3. Сидирование базы данных
Необходимо написать скрипты сидирования базы данных для проверки корректности структуры таблиц и тестирования производительности.

**Условия выполнения:**
- Сидирование выполняется автоматически при развертывании контейнера, если `APP_ENV=dev`
- Количество кортежей в таблицах нормируется от значения переменной окружения `SEED_COUNT`
- Сидирование должно работать для ЛЮБОЙ версии миграции

**Требования к данным:**
- Моковые данные должны имитировать реальные по значениям, повторениям и количеству кортежей
- Рекомендуется использовать библиотеку Faker
- При использовании sidecar-подхода: написать healthcheck для PostgreSQL и контейнер, который дожидается поднятия БД, выполняет сидирование и отключается

### 4. Настройка ролевой модели
Необходимо создать групповую роль с ограниченными правами доступа.

**Требования:**
- Создать групповую роль `analytic` с возможностью читать, но не изменять данные в отношениях
- Создать n-ное количество пользователей, унаследованных от роли `analytic`
- Список имен пользователей берется из переменной окружения `ANALYST_NAMES` (разделитель - запятая)
- Пароль пользователей в формате: `имяпользователя_123`

**Примечание:** Групповая роль - это роль, под которой в базу данных нельзя зайти напрямую.